<!DOCTYPE html>
<html>
<head>
    <title>release-team-status</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function Traverse(obj){this.value=obj}function walk(root,cb,immutable){var path=[],parents=[],alive=!0;return function walker(node_){function updateState(){if("object"==typeof state.node&&null!==state.node){state.keys&&state.node_===state.node||(state.keys=objectKeys(state.node)),state.isLeaf=0===state.keys.length;for(var i=0;parents.length>i;i++)if(parents[i].node_===node_){state.circular=parents[i];break}}else state.isLeaf=!0,state.keys=null;state.notLeaf=!state.isLeaf,state.notRoot=!state.isRoot}var node=immutable?copy(node_):node_,modifiers={},keepGoing=!0,state={node:node,node_:node_,path:[].concat(path),parent:parents[parents.length-1],parents:parents,key:path.slice(-1)[0],isRoot:0===path.length,level:path.length,circular:null,update:function(x,stopHere){state.isRoot||(state.parent.node[state.key]=x),state.node=x,stopHere&&(keepGoing=!1)},"delete":function(stopHere){delete state.parent.node[state.key],stopHere&&(keepGoing=!1)},remove:function(stopHere){isArray(state.parent.node)?state.parent.node.splice(state.key,1):delete state.parent.node[state.key],stopHere&&(keepGoing=!1)},keys:null,before:function(f){modifiers.before=f},after:function(f){modifiers.after=f},pre:function(f){modifiers.pre=f},post:function(f){modifiers.post=f},stop:function(){alive=!1},block:function(){keepGoing=!1}};if(!alive)return state;updateState();var ret=cb.call(state,state.node);return void 0!==ret&&state.update&&state.update(ret),modifiers.before&&modifiers.before.call(state,state.node),keepGoing?("object"!=typeof state.node||null===state.node||state.circular||(parents.push(state),updateState(),forEach(state.keys,function(key,i){path.push(key),modifiers.pre&&modifiers.pre.call(state,state.node[key],key);var child=walker(state.node[key]);immutable&&hasOwnProperty.call(state.node,key)&&(state.node[key]=child.node),child.isLast=i==state.keys.length-1,child.isFirst=0===i,modifiers.post&&modifiers.post.call(state,child),path.pop()}),parents.pop()),modifiers.after&&modifiers.after.call(state,state.node),state):state}(root).node}function copy(src){if("object"==typeof src&&null!==src){var dst;if(isArray(src))dst=[];else if(isDate(src))dst=new Date(src.getTime?src.getTime():src);else if(isRegExp(src))dst=RegExp(src);else if(isError(src))dst={message:src.message};else if(isBoolean(src))dst=new Boolean(src);else if(isNumber(src))dst=new Number(src);else if(isString(src))dst=new String(src);else if(Object.create&&Object.getPrototypeOf)dst=Object.create(Object.getPrototypeOf(src));else if(src.constructor===Object)dst={};else{var proto=src.constructor&&src.constructor.prototype||src.__proto__||{},T=function(){};T.prototype=proto,dst=new T}return forEach(objectKeys(src),function(key){dst[key]=src[key]}),dst}return src}function toS(obj){return Object.prototype.toString.call(obj)}function isDate(obj){return"[object Date]"===toS(obj)}function isRegExp(obj){return"[object RegExp]"===toS(obj)}function isError(obj){return"[object Error]"===toS(obj)}function isBoolean(obj){return"[object Boolean]"===toS(obj)}function isNumber(obj){return"[object Number]"===toS(obj)}function isString(obj){return"[object String]"===toS(obj)}var traverse=function(obj){return new Traverse(obj)};Traverse.prototype.get=function(ps){for(var node=this.value,i=0;ps.length>i;i++){var key=ps[i];if(!node||!hasOwnProperty.call(node,key)){node=void 0;break}node=node[key]}return node},Traverse.prototype.has=function(ps){for(var node=this.value,i=0;ps.length>i;i++){var key=ps[i];if(!node||!hasOwnProperty.call(node,key))return!1;node=node[key]}return!0},Traverse.prototype.set=function(ps,value){for(var node=this.value,i=0;ps.length-1>i;i++){var key=ps[i];hasOwnProperty.call(node,key)||(node[key]={}),node=node[key]}return node[ps[i]]=value,value},Traverse.prototype.map=function(cb){return walk(this.value,cb,!0)},Traverse.prototype.forEach=function(cb){return this.value=walk(this.value,cb,!1),this.value},Traverse.prototype.reduce=function(cb,init){var skip=1===arguments.length,acc=skip?this.value:init;return this.forEach(function(x){this.isRoot&&skip||(acc=cb.call(this,acc,x))}),acc},Traverse.prototype.paths=function(){var acc=[];return this.forEach(function(x){acc.push(this.path)}),acc},Traverse.prototype.nodes=function(){var acc=[];return this.forEach(function(x){acc.push(this.node)}),acc},Traverse.prototype.clone=function(){var parents=[],nodes=[];return function clone(src){for(var i=0;parents.length>i;i++)if(parents[i]===src)return nodes[i];if("object"==typeof src&&null!==src){var dst=copy(src);return parents.push(src),nodes.push(dst),forEach(objectKeys(src),function(key){dst[key]=clone(src[key])}),parents.pop(),nodes.pop(),dst}return src}(this.value)};var objectKeys=Object.keys||function keys(obj){var res=[];for(var key in obj)res.push(key);return res},isArray=Array.isArray||function isArray(xs){return"[object Array]"===Object.prototype.toString.call(xs)},forEach=function(xs,fn){if(xs.forEach)return xs.forEach(fn);for(var i=0;xs.length>i;i++)fn(xs[i],i,xs)};forEach(objectKeys(Traverse.prototype),function(key){traverse[key]=function(obj){var args=[].slice.call(arguments,1),t=new Traverse(obj);return t[key].apply(t,args)}});var hasOwnProperty=Object.hasOwnProperty||function(obj,key){return key in obj};
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){app=this,app.noreleasetext="-- Ignore Release Filter --",app.addReleaseDropDown()},addReleaseDropDown:function(){app.dropDown=Ext.create("Rally.ui.combobox.ReleaseComboBox",{allowNoEntry:!0,noEntryValue:"/release/-1",clearText:app.noreleasetext,allowClear:!0,emptyText:"Filter by release...",context:this.getContext(),defaultToCurrentTimebox:!1,defaultSelectionPosition:null,listeners:{scope:this,select:function(){app._showMask("Loading"),app.reload()},ready:function(){app._showMask("Loading"),app.reload()}}}),app.add(app.dropDown)},loadIterations:function(releaseRecord,callback){if(null===releaseRecord||releaseRecord.data.Name===app.noreleasetext||"Unscheduled"===releaseRecord.data.Name)var filter=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:">=",value:new Date});else var ffilter=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:releaseRecord.raw.ReleaseStartDate}),filter=ffilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:releaseRecord.raw.ReleaseDate}));var configs=[{model:"Iteration",fetch:!0,filters:[filter]}];async.map(configs,app.wsapiQuery,function(err,results){callback(null,results[0])})},createTaskFilter:function(iterations){var filter=null;return _.each(iterations,function(iteration,i){var f=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operator:"=",value:iteration.get("_ref")});filter=0===i?f:filter.or(f)}),filter},reload:function(){if(app.tree&&app.tree.destroy(),null===app.dropDown.getRecord())var releaseName="";else var releaseName=app.dropDown.getRecord().get("Name");async.map([app.dropDown.getRecord()],app.loadIterations,function(err,results){var iterations=results[0];if(0!==iterations.length){var taskFilter=app.createTaskFilter(iterations),taskConfig={model:"Task",fetch:!0,filters:[taskFilter]};async.map([taskConfig],app.wsapiQuery,function(err,results){var tasks=results[0];if(0===tasks.length)return app._hideMask(),app.noData(),void 0;var userIterations=_.map(tasks,function(t){return{user:t.get("Owner"),iteration:t.get("Iteration")}});userIterations=_.uniq(userIterations),userIterations=_.filter(userIterations,function(ui){return!(_.isUndefined(ui.user)||_.isUndefined(ui.iteration)||_.isNull(ui.user)||_.isNull(ui.iteration))});var configs=_.map(userIterations,function(ui){return{model:"UserIterationCapacity",fetch:!0,filters:[{property:"Iteration",operator:"=",value:ui.iteration._ref},{property:"User",operator:"=",value:ui.user._ref}]}});async.map(configs,app.wsapiQuery,function(err,results){app.tasks=tasks,app.capacities=_.flatten(results),app.addTreeGrid()})})}})},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},tasksToRecs:function(tasks){return _.map(tasks,function(task){return{user:task.get("FormattedID"),project:task.get("Project")?task.get("Project")._refObjectName:"none",iteration:task.get("Iteration")?task.get("Iteration")._refObjectName:"none",task:task.get("Name")?task.get("Name"):"none",estimate:task.get("Estimate")?task.get("Estimate"):0,todo:task.get("ToDo")?task.get("ToDo"):0,actuals:task.get("Actuals")?task.get("Actuals"):0,leaf:!0}})},noData:function(){app.tree=Ext.create("Ext.container.Container",{html:"No data found"}),app.add(app.tree)},addTreeGrid:function(){var items={text:".",children:[]},g=_.groupBy(app.tasks,function(t){return t.get("Owner")?t.get("Owner")._refObjectName:"none"});_.each(_.keys(g),function(okey){var byOwner=g[okey],rec={user:okey,children:[]},gProjects=_.groupBy(byOwner,function(t){return t.get("Project")?t.get("Project")._refObjectName:"none"});_.each(_.keys(gProjects),function(pKey){var byProject=gProjects[pKey],pRec={user:pKey,children:[]},gIterations=_.groupBy(byProject,function(t){return t.get("Iteration")?t.get("Iteration")._refObjectName:"none"});_.each(_.keys(gIterations),function(iKey){var byIteration=gIterations[iKey],iRec={user:iKey,children:app.tasksToRecs(byIteration)};pRec.children.push(iRec);var icapacity=_.find(app.capacities,function(ac){return ac.get("User")._refObjectName==okey&&ac.get("Project")._refObjectName==pKey&&ac.get("Iteration")._refObjectName==iKey});iRec.capacity=icapacity?icapacity.get("Capacity"):0}),rec.children.push(pRec)}),items.children.push(rec)});var sumLevelForKey=function(node,key){var t=traverse(node).reduce(function(acc,y){return this.key==key&&(acc+=y),acc},0);node[key]=t},calcLoad=function(node){node.load=node.estimate/node.capacity},calcProgress=function(node){node.progress=(node.estimate-node.todo)/node.estimate};traverse(items).forEach(function(x){(6===this.level||4===this.level||2===this.level)&&(sumLevelForKey(x,"estimate"),sumLevelForKey(x,"todo"),sumLevelForKey(x,"actuals")),(2===this.level||4===this.level)&&sumLevelForKey(x,"capacity"),(6===this.level||4===this.level||2===this.level)&&(calcLoad(x),calcProgress(x))}),Ext.define("TreeTask",{extend:"Ext.data.Model",fields:[{name:"user",type:"string"},{name:"task",type:"string"},{name:"load",type:"number"},{name:"progress",type:"number"},{name:"capacity",type:"number"},{name:"estimate",type:"number"},{name:"todo",type:"number"},{name:"actuals",type:"number"}]});var store=Ext.create("Ext.data.TreeStore",{model:"TreeTask",proxy:{type:"memory"},foldersort:!0}),rootNode=store.setRootNode(items);app.tree&&app.tree.destroy(),app.tree=Ext.create("Ext.tree.Panel",{layout:"fit",collapsible:!1,useArrows:!0,rootVisible:!1,store:store,multiSelect:!1,singleExpand:!1,columns:[{xtype:"treecolumn",text:"Owner",sortable:!0,dataIndex:"user",width:200},{text:"Task",width:300,dataIndex:"task",sortable:!0},{text:"Progress",width:100,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{percentDoneName:"progress",showOnlyIfInProgress:!0,height:"15px",calculateColorFn:function(recordData){return"lightblue"}})},{text:"Load",width:100,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{percentDoneName:"load",showOnlyIfInProgress:!0,height:"15px",calculateColorFn:function(recordData){return colVal=.8>recordData.load?"#B2E3B6":1>recordData.load?"#FBDE98":"#FCB5B1"}})},{text:"Capacity",dataIndex:"capacity",align:"right",sortable:!0,renderer:app.renderNumber},{text:"Estimate",dataIndex:"estimate",align:"right",sortable:!0,renderer:app.renderNumber},{text:"ToDo",dataIndex:"todo",align:"right",sortable:!0,renderer:app.renderNumber},{text:"Actuals",dataIndex:"actuals",align:"right",sortable:!0,renderer:app.renderNumber}],listeners:{viewready:function(){app._hideMask()}}}),app.add(app.tree)},_showMask:function(msg){this.getEl()&&(this.getEl().unmask(),this.getEl().mask(msg))},_hideMask:function(){this.getEl().unmask()},renderNumber:function(v){return v>0?v:""}});

            Rally.launchApp('CustomApp', {
                name:"release-team-status",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-grid-row:nth-of-type(odd) .x-grid-cell{background-color:#D3E8EC}
    </style>
</head>
<body>
</body>
</html>
